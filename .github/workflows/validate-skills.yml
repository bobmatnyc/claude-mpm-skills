name: Validate Skills

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate skill structure
        run: |
          echo "üîç Validating skill structure..."

          # Check all SKILL.md files exist (excluding references/ directories)
          # Check depths 3-4 to handle both flat and nested structures
          for depth in 3 4; do
            find toolchains/ universal/ -type d -mindepth $depth -maxdepth $depth 2>/dev/null | grep -v "/references$" | while read dir; do
              # Only validate if it contains actual skill files (has SKILL.md or metadata.json)
              if [ -f "$dir/SKILL.md" ] || [ -f "$dir/metadata.json" ]; then
                if [ ! -f "$dir/SKILL.md" ]; then
                  echo "‚ùå Missing SKILL.md in $dir"
                  exit 1
                fi
                if [ ! -f "$dir/metadata.json" ]; then
                  echo "‚ùå Missing metadata.json in $dir"
                  exit 1
                fi
              fi
            done
          done

          echo "‚úÖ All skills have required files"

      - name: Validate manifest
        run: |
          echo "üîç Validating manifest.json..."

          if [ ! -f "manifest.json" ]; then
            echo "‚ùå manifest.json not found"
            exit 1
          fi

          # Validate JSON syntax
          if ! python3 -m json.tool manifest.json > /dev/null; then
            echo "‚ùå manifest.json is not valid JSON"
            exit 1
          fi

          echo "‚úÖ manifest.json is valid"

      - name: Check for sensitive data
        run: |
          echo "üîç Checking for sensitive data..."

          # Only check for real secrets with specific patterns (not documentation examples)
          # Look for actual API keys that match common formats
          if grep -rE "sk-[a-zA-Z0-9]{32,}|ghp_[a-zA-Z0-9]{36}|xox[baprs]-[a-zA-Z0-9-]{10,}" --include="*.md" --include="*.json" toolchains/ universal/; then
            echo "‚ùå Actual API key or token detected"
            exit 1
          fi

          # Check for private keys
          if grep -r "BEGIN PRIVATE KEY\|BEGIN RSA PRIVATE KEY" --include="*.md" --include="*.json" toolchains/ universal/; then
            echo "‚ùå Private key detected"
            exit 1
          fi

          # Check for AWS credentials
          if grep -rE "AKIA[0-9A-Z]{16}" --include="*.md" --include="*.json" toolchains/ universal/; then
            echo "‚ùå AWS access key detected"
            exit 1
          fi

          echo "‚úÖ No actual secrets detected"
